<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
<head>
<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="sockjs-0.3.4.min.js"></script>
<script src="stomp.min.js"></script>
</head>

<body>
	<h1><b>Send Message to Specific Session</b></h1>
	<p>Open this application in multiple browser window. For each
		instance of app separate sessionid and transactioid will be generated.</p>
	<p>SessionId is used by backend service to send message to specific instance of
		application.</p>
	<p>Transaction id is some transaction processed by distributed
		system. Ideally when job is submitted, system will return transactionID. 
		So when updates are received for the transaction this service
		will lookup session/app instance which started the transaction and
		send updates only to that app instance over websocket</p>
	<p>Application should call register endpoint by passing the session
		and transaction id.</p>
	<p>Application should call unregister endpoint by passing the
		session and transaction id when application is closed.</p>
	<p>
		<b>Session ID for this instance of App :</b>
	</p>
	<label id="sessionIdLabel"></label>
	<br>
	<p>
		<b>Transaction ID for demo: </b>
	</p>
	<label id="transactionIdLabel"></label>
	<p>Notifications received on the web socket channel will be
		displayed below:</p>
	<textarea id="notifications-area" cols="60" rows="10"
		readonly="readonly"></textarea>
	<p>
		To avoind complexity, for this demo, transaction id is generated by front end application only.
		Assume that this transactionId is generated by backend system.
		Use RabbitMQ management console to sned message. Use the transactionId displayed on page
		Notice that every instance of page has different transactioid and sessioid.
		When message is sent to RabbitMQ queue, it will be displayed on the correct page.  
		<img src="raabitmq_send_message.PNG"/>
	</p>
	<!-- Javascript functions -->
	<script>
		/**
		 * Open the web socket connection and subscribe the "/notify" channel.
		 */
		var stompClient;
		var sessionId;
		var transactionId;
		function connect() {

			// Create and init the SockJS object
			var socket = new SockJS('/ws');
			stompClient = Stomp.over(socket);

			// Subscribe the '/notify' channell
			stompClient.connect({}, function(frame) {
				//logic to extract sessionid
				var urlarray = socket._transport.url.split('/');
				var index = urlarray.length - 2;
				sessionId = urlarray[index];
				//transaction id is just a random guid for demo purpose
				transactionId = guid();
				//transactionId="d1d08b0b-8a7b-4930-aa50-e4628de00ff2";
				$('#sessionIdLabel').html(sessionId);
				$('#transactionIdLabel').html(transactionId);
				//client will subscribe for updates on this endpoint
				stompClient.subscribe('/user/queue/notify', function(
						notification) {
					// Call the notify function when receive a notification
					notify(notification.body);

				});
				//App should register itself by calling this method
				register(sessionId, transactionId);
			});
			return;
		} // function connect

		/**
		 * Display the notification message.
		 */
		function notify(message) {
			$("#notifications-area").append(message + "\n");
			return;
		}

		function register(sessionId, transactionId) {
			var message = {
				"sessionId" : sessionId,
				"transactionId" : transactionId
			};
			var stringMessage = JSON.stringify(message);
			console.log(stringMessage);
			stompClient.send("/app/register", {}, stringMessage);
		}

		function unregister(sessionId, transactionId) {
			var message = {
				"sessionId" : sessionId,
				"transactionId" : transactionId
			};
			var stringMessage = JSON.stringify(message);
			console.log(stringMessage);
			stompClient.send("/app/unregister", {}, stringMessage);
		}

		//ref: https://stackoverflow.com/questions/105034/create-guid-uuid-in-javascript 
		function guid() {
			function s4() {
				return Math.floor((1 + Math.random()) * 0x10000).toString(16)
						.substring(1);
			}
			return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-'
					+ s4() + s4() + s4();
		}

		window.onbeforeunload = function(e) {
			// Call this method when logging off also
			unregister(sessionId, transactionId);
		};

		/**
		 * Init operations.
		 */
		$(document).ready(function() {

			// Start the web socket connection.
			connect();

		});
	</script>

	<br />
	<hr />


</body>

</html>
